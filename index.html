<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unity Rich Text (TextMesh Pro) – WYSIWYG Preview</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Averia+Sans+Libre:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --panel:#0e0e0e;
      --muted:#9aa0a6;
      --accent:#4f46e5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg); font-family:"Averia Sans Libre", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:grid; grid-template-rows:auto 1fr auto; gap:12px;
    }
    header{padding:14px 18px; border-bottom:1px solid #1f1f1f; position:sticky; top:0; background:linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.55)); backdrop-filter: blur(8px)}
    header h1{margin:0; font-size:20px; letter-spacing:.3px}
    header .sub{color:var(--muted); font-size:12px}

    .wrap{display:grid; grid-template-columns:1fr 1fr; gap:14px; padding:0 18px 8px 18px}
    @media (max-width: 960px){ .wrap{grid-template-columns:1fr;}}

    .card{background:var(--panel); border:1px solid #1f1f1f; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; min-height:260px}
    .card h2{margin:0; padding:12px 14px; font-size:14px; border-bottom:1px solid #1f1f1f; color:#d6d6d6}
    .card .body{padding:12px; display:flex; flex-direction:column; gap:8px; height:100%}

    textarea{
      width:100%; height:360px; resize:vertical; background:#0b0b0b; color:var(--fg); border:1px solid #222; border-radius:12px; padding:12px; font: 400 16px/1.45 "Averia Sans Libre", sans-serif;
      outline:none; box-shadow:none; transition: border .15s, box-shadow .15s
    }
    textarea:focus{border-color:#2d2d2d; box-shadow:0 0 0 3px color-mix(in oklab, var(--accent), transparent 70%)}

    .toolbar{display:flex; flex-wrap:wrap; gap:8px}
    .btn{background:#121212; border:1px solid #262626; color:#ddd; padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer}
    .btn:hover{border-color:#3a3a3a}

    .preview{
      background:#000; color:#fff; border:1px solid #222; border-radius:12px; padding:16px; min-height:360px; overflow:auto;
      font: 400 18px/1.5 "Averia Sans Libre", sans-serif;
      white-space: pre-wrap;
    }

    .meta{display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; padding:0 18px 16px 18px}
    .muted{color:var(--muted)}

    .preview b,strong{font-weight:700}
    .preview i, .preview em{font-style:italic}
    .preview u{text-decoration:underline}
    .preview s, .preview del{text-decoration:line-through}
    .preview mark{background:rgba(255,255,0,.35); padding:0 .1em; border-radius:.15em}
    .preview .smallcaps{font-variant:small-caps}
    .preview .indent{display:inline-block; text-indent:2em}
    .preview .left{text-align:left}
    .preview .center{text-align:center}
    .preview .right{text-align:right}
  </style>
</head>
<body>
  <header>
    <h1>Unity Rich Text (TextMesh Pro) – WYSIWYG Preview</h1>
    <div class="sub">Type TMP/Unity Rich Text markup on the left; see how it will render on the right. Default: white text on black. Font: Averia Sans Libre.</div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Editor</h2>
      <div class="body">
        <div class="toolbar">
          <button class="btn" data-insert="<b></b>"><b>B</b></button>
          <button class="btn" data-insert="<i></i"><i>I</i></button>
          <button class="btn" data-insert="<u></u>"><u>U</u></button>
          <button class="btn" data-insert="<s></s>">S</button>
          <button class="btn" data-insert="<sup></sup>">sup</button>
          <button class="btn" data-insert="<sub></sub>">sub</button>
          <button class="btn" data-insert="<size=120%></size>">size=120%</button>
          <button class="btn" data-insert="<color=#ff6></color>">color=#ff6</button>
          <button class="btn" data-insert="<mark=#440></mark>">mark=#440</button>
          <button class="btn" data-insert="<align=center></align>">align=center</button>
          <button class="btn" id="btnClear">Clear</button>
        </div>
        <textarea id="src" placeholder="Example:\n<#f00>red<#00f>blue</color>red</color>white"></textarea>
      </div>
    </section>

    <section class="card">
      <h2>Preview</h2>
      <div class="body">
        <div id="preview" class="preview" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <footer class="meta">
    <div>Characters (including whitespace): <span id="charCount">0</span></div>
    <div class="muted">This is a client-side demo; no text is uploaded.</div>
  </footer>

  <script>
    const src = document.getElementById('src');
    const preview = document.getElementById('preview');
    const charCount = document.getElementById('charCount');

    function escapeHTML(str){
      return str
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
    }

    function colorToCSS(val){
      const v = val.trim();
      if(/^#([0-9a-fA-F]{3})$/.test(v)){
        return '#' + v[1] + v[1] + v[2] + v[2] + v[3] + v[3];
      }
      if(/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(v)) return v;
      if(/^[a-zA-Z]+$/.test(v)) return v;
      return null;
    }

    function sizeToCSS(val){
      const v = val.trim();
      if(/^[-+]?\d+%$/.test(v)) return v;
      if(/^[-+]?\d+(px|em|rem)$/.test(v)) return v;
      if(/^[-+]?\d+$/.test(v)) return v + 'px';
      return null;
    }

    function parseTMP(input){
      let out = escapeHTML(input);

      const tagMap = [
        {open:/&lt;b&gt;/gi, close:/&lt;\/b&gt;/gi, repOpen:'<strong>', repClose:'</strong>'},
        {open:/&lt;i&gt;/gi, close:/&lt;\/i&gt;/gi, repOpen:'<em>', repClose:'</em>'},
        {open:/&lt;u&gt;/gi, close:/&lt;\/u&gt;/gi, repOpen:'<u>', repClose:'</u>'},
        {open:/&lt;s&gt;/gi, close:/&lt;\/s&gt;/gi, repOpen:'<s>', repClose:'</s>'},
        {open:/&lt;sup&gt;/gi, close:/&lt;\/sup&gt;/gi, repOpen:'<sup>', repClose:'</sup>'},
        {open:/&lt;sub&gt;/gi, close:/&lt;\/sub&gt;/gi, repOpen:'<sub>', repClose:'</sub>'},
        {open:/&lt;smallcaps&gt;/gi, close:/&lt;\/smallcaps&gt;/gi, repOpen:'<span class="smallcaps">', repClose:'</span>'},
      ];
      for(const t of tagMap){ out = out.replace(t.open, t.repOpen).replace(t.close, t.repClose); }

      out = out.replace(/&lt;br\s*\/??&gt;/gi, '<br>');

      // Nested color handling
      out = out.replace(/&lt;color=([^&]+?)&gt;/gi, (m, val) => {
        const css = colorToCSS(val) || 'inherit';
        return `<span style="color:${css}">`;
      });
      out = out.replace(/&lt;#([0-9a-fA-F]{3,6})&gt;/gi, (m, hex) => {
        let color;
        if(hex.length === 3){
          color = '#' + hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
        } else {
          color = '#' + hex;
        }
        return `<span style="color:${color}">`;
      });
      out = out.replace(/&lt;\/color&gt;/gi, '</span>');

      out = out.replace(/&lt;size=([^&]+?)&gt;/gi, (m, val) => {
        const css = sizeToCSS(val) || 'inherit';
        return `<span style="font-size:${css}">`;
      });
      out = out.replace(/&lt;\/size&gt;/gi, '</span>');

      out = out.replace(/&lt;mark(?:=([^&]+?))?&gt;/gi, (m, val) => {
        const bg = val ? colorToCSS(val) : null;
        const style = bg ? `background:${bg}` : '';
        return `<mark style="${style}">`;
      });
      out = out.replace(/&lt;\/mark&gt;/gi, '</mark>');

      out = out.replace(/&lt;align="(left|center|right)"&gt;/gi, (m, where) => {
        return `<div class="${where}">`;
      });
      out = out.replace(/&lt;\/align&gt;/gi, '</div>');

      // Handle <cspace=...>
      out = out.replace(/&lt;cspace=([-+]?\d*\.?\d+)&gt;/gi, (match, p1) => {
        return `<span style="letter-spacing:${p1}em;">`;
      });
      out = out.replace(/&lt;\/cspace&gt;/gi, "</span>");

      out = out.replace(/&lt;line-height=([^&]+?)&gt;/gi, (m, val) => {
        return `<div style=\"line-height:${val}\">`;
      });
      out = out.replace(/&lt;\/line-height&gt;/gi, '</div>');

      out = out.replace(/&lt;voffset=([^&]+?)&gt;/gi, (m, val) => {
        return `<span style=\"position:relative; top:${val}\">`;
      });
      out = out.replace(/&lt;\/voffset&gt;/gi, '</span>');

      out = out.replace(/&lt;indent=([^&]+?)&gt;/gi, (m, val) => {
        return `<div style=\"text-indent:${val}\">`;
      });
      out = out.replace(/&lt;\/indent&gt;/gi, '</div>');

      return out;
    }

    function update(){
      const text = src.value;
      charCount.textContent = String(text.length);
      preview.innerHTML = parseTMP(text);
    }

    src.addEventListener('input', update);

    document.querySelectorAll('.btn[data-insert]').forEach(btn => {
      btn.addEventListener('click', () => {
        const tpl = btn.getAttribute('data-insert');
        const el = src;
        const [start, end] = [el.selectionStart ?? el.value.length, el.selectionEnd ?? el.value.length];
        const before = el.value.slice(0, start);
        const sel = el.value.slice(start, end);
        const after = el.value.slice(end);
        let insert = tpl;
        const closeIdx = tpl.indexOf('</');
        if(closeIdx !== -1){
          insert = tpl.replace('</', sel + '</');
        }
        el.value = before + insert + after;
        const pos = (before + insert).length;
        el.focus();
        el.setSelectionRange(pos, pos);
        update();
      });
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      src.value = '';
      update();
      src.focus();
    });

    update();
  </script>
</body>
</html>
